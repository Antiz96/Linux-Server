---
# tasks file for dump_zabbix_db

# Perform a dump of the Zabbix's database
- name: Dump Zabbix database
  shell:
    cmd: docker exec -t postgres pg_dumpall -c -U $(cat /opt/postgres/env/user) -l $(cat /opt/postgres/env/database) | sudo tee /opt/postgres/backup/dump_$(date +%d-%m-%Y).sql

# Find dumps that are equal to or older than a week
- name: List old dumps
  find:
    paths: /opt/postgres/backup
    patterns: '*.sql'
    age: 1w
  register: list_old_dumps

# Delete dumps that are equal to or older than a week (and print them)
- name: Delete old dumps
  file:
    path: "{{item.path}}"
    state: absent
  with_items: "{{list_old_dumps.files}}"
